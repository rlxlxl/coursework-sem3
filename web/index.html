<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Интеграторы инфобеза</title>
<style>
body { font-family: Arial; padding: 20px; }
table { border-collapse: collapse; width: 100%; margin-top: 10px; }
th, td { border: 1px solid #ccc; padding: 8px; }
th { background-color: #f0f0f0; }
input, button { padding: 5px; margin: 2px 0; }
.admin { margin-top: 20px; border: 1px solid #aaa; padding: 10px; background: #f9f9f9; display:none; }
#adminAccess { margin-top:20px; }
</style>
</head>
<body>

<h1>Список интеграторов</h1>

<table id="integratorTable">
<thead>
<tr><th>ID</th><th>Название</th><th>Город</th><th>Описание</th></tr>
</thead>
<tbody></tbody>
</table>

<div id="adminAccess">
<button id="showAdminBtn">Доступ к админ-панели</button>
<div id="adminLogin" style="display:none; margin-top:10px;">
<label>Пароль: <input type="password" id="adminPassLogin"></label>
<button id="loginBtn">Войти</button>
</div>
</div>

<div class="admin" id="adminPanel">
<h2>Админ-панель</h2>

<h3>Добавить интегратора</h3>
<label>Название: <input type="text" id="name"></label><br>
<label>Город: <input type="text" id="city"></label><br>
<label>Описание: <input type="text" id="desc"></label><br>
<button id="addBtn">Добавить</button>

<h3>Сменить пароль</h3>
<label>Старый пароль: <input type="password" id="oldpass"></label><br>
<label>Новый пароль: <input type="password" id="newpass"></label><br>
<button id="changePassBtn">Сменить пароль</button>
</div>

<script>
let adminAuthenticated = false;

async function loadIntegrators() {
    try {
        const res = await fetch('/list');
        const data = await res.json();
        const tbody = document.querySelector('#integratorTable tbody');
        tbody.innerHTML = '';
        data.forEach(i => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${i.id}</td><td>${i.name}</td><td>${i.city}</td><td>${i.description}</td>`;
            tbody.appendChild(tr);
        });
    } catch(err){ alert('Ошибка загрузки: '+err); }
}

document.getElementById('showAdminBtn').onclick = () => {
    document.getElementById('adminLogin').style.display = 'block';
};

document.getElementById('loginBtn').onclick = async () => {
    const pwd = document.getElementById('adminPassLogin').value.trim();
    if(!pwd){ alert('Введите пароль'); return; }

    try{
        const form = new URLSearchParams();
        form.append('admin', pwd);

        const res = await fetch('/admin_login', {method:'POST', body:form});
        if(res.status === 200){
            adminAuthenticated = true;
            alert('Авторизация успешна');
            document.getElementById('adminPanel').style.display = 'block';
            document.getElementById('adminLogin').style.display = 'none';
            loadIntegrators(); // обновим таблицу
        } else {
            alert('Неверный пароль');
        }
    } catch(err){ alert('Ошибка: '+err); }
};


// Добавление интегратора
document.getElementById('addBtn').onclick = async () => {
    if(!adminAuthenticated){ alert('Неавторизован'); return; }
    const name = document.getElementById('name').value.trim();
    const city = document.getElementById('city').value.trim();
    const desc = document.getElementById('desc').value.trim();
    const admin = document.getElementById('adminPassLogin').value.trim();
    if(!name){ alert('Введите название'); return; }

    const form = new URLSearchParams();
    form.append('name', name);
    form.append('city', city);
    form.append('description', desc);
    form.append('admin', admin);

    try {
        const res = await fetch('/admin_add',{method:'POST', body:form});
        if(res.status!=200){ alert(await res.text()); return; }
        alert('Интегратор добавлен!');
        document.getElementById('name').value='';
        document.getElementById('city').value='';
        document.getElementById('desc').value='';
        loadIntegrators();
    } catch(err){ alert('Ошибка: '+err); }
};

// Смена пароля
document.getElementById('changePassBtn').onclick = async () => {
    if(!adminAuthenticated){ alert('Неавторизован'); return; }
    const oldpass = document.getElementById('oldpass').value.trim();
    const newpass = document.getElementById('newpass').value.trim();
    if(!oldpass || !newpass){ alert('Заполните оба поля'); return; }

    const form = new URLSearchParams();
    form.append('oldpass', oldpass);
    form.append('newpass', newpass);

    try{
        const res = await fetch('/admin_change_pass',{method:'POST', body:form});
        const text = await res.text();
        if(res.status!=200){ alert('Ошибка: '+text); return; }
        alert(text);
        document.getElementById('oldpass').value='';
        document.getElementById('newpass').value='';
    } catch(err){ alert('Ошибка: '+err); }
};

// загрузка таблицы при старте
window.onload = loadIntegrators;
</script>

</body>
</html>
