<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Интеграторы инфобеза</title>
<style>
/* Общие стили */
body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #f7f8fc;
    margin: 0;
    padding: 20px;
    color: #333;
}

h1, h2, h3 {
    text-align: center;
    color: #222;
}

.container {
    max-width: 900px;
    margin: auto;
}

/* Таблица */
table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    background: #fff;
}

th, td {
    padding: 12px 15px;
    text-align: left;
}

th {
    background-color: #4CAF50;
    color: white;
}

tr:nth-child(even) {
    background-color: #f2f2f2;
}

/* Кнопки */
button {
    padding: 10px 20px;
    margin: 5px 0;
    border: none;
    border-radius: 6px;
    background-color: #4CAF50;
    color: white;
    cursor: pointer;
    font-weight: bold;
    transition: 0.3s;
}

button:hover {
    background-color: #45a049;
}

/* Поля ввода */
input[type=text], input[type=password] {
    padding: 8px;
    width: 100%;
    box-sizing: border-box;
    margin: 5px 0 15px 0;
    border: 1px solid #ccc;
    border-radius: 5px;
}

/* Админ-панель */
.admin, #adminLogin {
    background: #fff;
    padding: 20px;
    margin-top: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

/* Кнопка доступа к админ-панели */
#showAdminBtn {
    display: block;
    margin: 20px auto;
}

/* Скрытые элементы */
.admin { display: none; }
#adminLogin { display: none; }

/* Подписи */
label {
    font-weight: bold;
}
</style>
</head>
<body>

<div class="container">
<h1>Интеграторы в сфере инфобезопасности</h1>

<table id="integratorTable">
<thead>
<tr><th>ID</th><th>Название</th><th>Город</th><th>Описание</th></tr>
</thead>
<tbody></tbody>
</table>

<div id="adminAccess">
<button id="showAdminBtn">Доступ к админ-панели</button>

<div id="adminLogin">
<h2>Авторизация администратора</h2>
<label>Пароль:</label>
<input type="password" id="adminPassLogin" placeholder="Введите пароль">
<button id="loginBtn">Войти</button>
</div>
</div>

<div class="admin" id="adminPanel">
<h2>Админ-панель</h2>

<h3>Добавить интегратора</h3>
<label>Название:</label>
<input type="text" id="name" placeholder="Название интегратора">
<label>Город:</label>
<input type="text" id="city" placeholder="Город">
<label>Описание:</label>
<input type="text" id="desc" placeholder="Описание">
<button id="addBtn">Добавить интегратора</button>

<h3>Сменить пароль</h3>
<label>Старый пароль:</label>
<input type="password" id="oldpass" placeholder="Старый пароль">
<label>Новый пароль:</label>
<input type="password" id="newpass" placeholder="Новый пароль">
<button id="changePassBtn">Сменить пароль</button>
</div>

</div>

<script>
// Авторизация
let adminAuthenticated = false;

async function loadIntegrators() {
    try {
        const res = await fetch('/list');
        const data = await res.json();
        const tbody = document.querySelector('#integratorTable tbody');
        tbody.innerHTML = '';
        data.forEach(i => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${i.id}</td><td>${i.name}</td><td>${i.city}</td><td>${i.description}</td>`;
            tbody.appendChild(tr);
        });
    } catch(err){ alert('Ошибка загрузки: '+err); }
}

// Кнопка "Доступ к админ-панели"
document.getElementById('showAdminBtn').onclick = () => {
    document.getElementById('adminLogin').style.display = 'block';
};

// Вход админа
document.getElementById('loginBtn').onclick = async () => {
    const pwd = document.getElementById('adminPassLogin').value.trim();
    if(!pwd){ alert('Введите пароль'); return; }

    try{
        const form = new URLSearchParams();
        form.append('admin', pwd);
        const res = await fetch('/admin_login', {method:'POST', body:form});
        if(res.status === 200){
            adminAuthenticated = true;
            alert('Авторизация успешна');
            document.getElementById('adminPanel').style.display = 'block';
            document.getElementById('adminLogin').style.display = 'none';
            loadIntegrators();
        } else {
            alert('Неверный пароль');
        }
    } catch(err){ alert('Ошибка: '+err); }
};

// Добавление интегратора
document.getElementById('addBtn').onclick = async () => {
    if(!adminAuthenticated){ alert('Неавторизован'); return; }
    const name = document.getElementById('name').value.trim();
    const city = document.getElementById('city').value.trim();
    const desc = document.getElementById('desc').value.trim();
    const admin = document.getElementById('adminPassLogin').value.trim();
    if(!name){ alert('Введите название'); return; }

    const form = new URLSearchParams();
    form.append('name', name);
    form.append('city', city);
    form.append('description', desc);
    form.append('admin', admin);

    try {
        const res = await fetch('/admin_add',{method:'POST', body:form});
        if(res.status!=200){ alert(await res.text()); return; }
        alert('Интегратор добавлен!');
        document.getElementById('name').value='';
        document.getElementById('city').value='';
        document.getElementById('desc').value='';
        loadIntegrators();
    } catch(err){ alert('Ошибка: '+err); }
};

// Смена пароля
document.getElementById('changePassBtn').onclick = async () => {
    if(!adminAuthenticated){ alert('Неавторизован'); return; }
    const oldpass = document.getElementById('oldpass').value.trim();
    const newpass = document.getElementById('newpass').value.trim();
    if(!oldpass || !newpass){ alert('Заполните оба поля'); return; }

    const form = new URLSearchParams();
    form.append('oldpass', oldpass);
    form.append('newpass', newpass);

    try{
        const res = await fetch('/admin_change_pass',{method:'POST', body:form});
        const text = await res.text();
        if(res.status!=200){ alert('Ошибка: '+text); return; }
        alert(text);
        document.getElementById('oldpass').value='';
        document.getElementById('newpass').value='';
    } catch(err){ alert('Ошибка: '+err); }
};

// Загрузка таблицы при старте
window.onload = loadIntegrators;
</script>

</body>
</html>
